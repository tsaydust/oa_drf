import{h as T,_ as Z,u as ee,a as c,b as te,d as q,e as a,w as s,O as ae,f as le,F as N,E as r,s as se,o as b,g as ne,i as O,j as w,c as B,k as g,l as $,t as E,m as oe,n as ie,r as i,p as ue,q as de,v as ce}from"./index-Bry-NjLa.js";const re=(d,u,o,p)=>T.post("/task/task",{title:d,content:u,assignee:o,department:p}),pe=(d=1,u=10,o)=>{const p="/task/task";return o=o||{},o.page=d,o.size=u,T.get(p,o)},me=(d,u,o,p,v)=>{const h="/task/task/"+d;return T.put(h,{title:u,content:o,assignee:p,department:v})},_e=d=>{const u="/task/task/"+d+"/complete";return T.post(u)},y={addTask:re,getTaskList:pe,updateTask:me,completeTask:_e},fe={class:"header-container"},ge={class:"left"},ve={__name:"list",setup(d){const u=ee(),o=u.isManager,p=u.isAdmin,v=c([]),h=c(1),L=c(10),M=c(0),k=c(!1),_=c("add"),x=c([]),t=c({title:"",content:"",assignee:"",department:""}),F={title:[{required:!0,message:"请输入任务标题",trigger:"blur"}],content:[{required:!0,message:"请输入任务内容",trigger:"blur"}],assignee:[{required:!0,message:"请选择执行人",trigger:"change"}]},V=async()=>{try{const l=await y.getTaskList(h.value,L.value);v.value=l.results,M.value=l.count}catch{r.error("加载任务列表失败")}},H=()=>{_.value="add",t.value={title:"",content:"",assignee:"",department:""},k.value=!0},P=l=>{_.value="edit",t.value={id:l.id,title:l.title,content:l.content,assignee:l.assignee,department:l.department.id},k.value=!0},j=async()=>{try{_.value==="add"?(await y.addTask(t.value.title,t.value.content,t.value.assignee,t.value.department),r.success("发布任务成功")):_.value==="manager_edit"?(await y.updateTask(t.value.id,t.value.title,t.value.content,t.value.assignee),r.success("更新任务成功")):(await y.updateTask(t.value.id,t.value.title,t.value.content,t.value.assignee),r.success("更新任务成功")),k.value=!1,V()}catch{r.error(_.value==="add"?"发布任务失败":"更新任务失败")}},D=async l=>{try{await ie.confirm("确认完成该任务？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await y.completeTask(l.id),r.success("完成任务成功"),V()}catch(n){n!=="cancel"&&r.error("只有任务执行者可以完成任务")}},I=l=>(o||p)&&l.status!=="completed",R=async()=>{try{const l=await se.getStaffList(1,1e3);x.value=l.results}catch{r.error("加载员工列表失败")}},G=l=>{const n=x.value.find(C=>C.id===l);n&&n.department&&(t.value.department=n.department.id)};return te(()=>{V(),R()}),(l,n)=>{const C=i("el-icon"),S=i("el-button"),f=i("el-table-column"),J=i("el-tag"),K=i("el-table"),Q=i("el-card"),z=i("el-input"),A=i("el-form-item"),W=i("el-option"),X=i("el-select"),Y=i("el-form");return b(),q(N,null,[a(ae,{title:"任务列表"},{default:s(()=>[a(Q,null,{footer:s(()=>[a(ne,{modelValue:h.value,"onUpdate:modelValue":n[0]||(n[0]=e=>h.value=e),total:M.value,"page-size":L.value,onPagination:V},null,8,["modelValue","total","page-size"])]),default:s(()=>[O("div",fe,[O("div",ge,[w(o)?(b(),B(S,{key:0,type:"primary",onClick:H},{default:s(()=>[a(C,null,{default:s(()=>[a(w(ue))]),_:1}),g(" 发起任务 ")]),_:1})):$("",!0)])]),a(K,{data:v.value,style:{width:"100%"},"row-style":{height:"60px"},border:""},{default:s(()=>[a(f,{prop:"title",label:"任务标题","show-overflow-tooltip":"",height:"60"}),a(f,{prop:"content",label:"任务内容","show-overflow-tooltip":"",height:"60"}),a(f,{label:"执行人",height:"60","show-overflow-tooltip":""},{default:s(({row:e})=>{var m;return[g(E((m=e.assignee_info)==null?void 0:m.username),1)]}),_:1}),a(f,{label:"所属部门",height:"60","show-overflow-tooltip":""},{default:s(({row:e})=>{var m,U;return[g(E((U=(m=e.assignee_info)==null?void 0:m.department)==null?void 0:U.name),1)]}),_:1}),a(f,{label:"状态",height:"60",width:"100",align:"center"},{default:s(({row:e})=>[a(J,{type:e.status==="completed"?"success":"info"},{default:s(()=>[g(E(e.status==="completed"?"已完成":"进行中"),1)]),_:2},1032,["type"])]),_:1}),a(f,{label:"操作",width:"150",fixed:"right",align:"center",height:"60"},{default:s(({row:e})=>[I(e)?(b(),B(S,{key:0,type:"primary",link:"",icon:w(de),onClick:m=>P(e),disabled:e.status==="completed"},{default:s(()=>[g(" 修改 ")]),_:2},1032,["icon","onClick","disabled"])):$("",!0),a(S,{type:"success",link:"",icon:w(ce),onClick:m=>D(e),disabled:e.status==="completed"},{default:s(()=>[g(" 完成 ")]),_:2},1032,["icon","onClick","disabled"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1}),a(le,{title:_.value==="add"?"发起任务":"编辑任务",modelValue:k.value,"onUpdate:modelValue":n[4]||(n[4]=e=>k.value=e),onSubmit:j},{default:s(()=>[a(Y,{ref:"formRef",model:t.value,rules:F,"label-width":"100px"},{default:s(()=>[a(A,{label:"标题",prop:"title"},{default:s(()=>[a(z,{modelValue:t.value.title,"onUpdate:modelValue":n[1]||(n[1]=e=>t.value.title=e),placeholder:"请输入任务标题",clearable:""},null,8,["modelValue"])]),_:1}),a(A,{label:"内容",prop:"content"},{default:s(()=>[a(z,{modelValue:t.value.content,"onUpdate:modelValue":n[2]||(n[2]=e=>t.value.content=e),type:"textarea",rows:4,placeholder:"请输入任务内容",resize:"none"},null,8,["modelValue"])]),_:1}),a(A,{label:"执行人",prop:"assignee"},{default:s(()=>[a(X,{modelValue:t.value.assignee,"onUpdate:modelValue":n[3]||(n[3]=e=>t.value.assignee=e),placeholder:"请选择执行人",style:{width:"100%"},clearable:"",onChange:G},{default:s(()=>[(b(!0),q(N,null,oe(x.value,e=>(b(),B(W,{key:e.id,label:e.username,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"])],64)}}},ke=Z(ve,[["__scopeId","data-v-ce13609c"]]);export{ke as default};
